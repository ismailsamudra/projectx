<style>.image_upload>form>input {display: none;}</style>
<!-- TOP NAVIGASI START -->
<div class="btl">
</div>
<div class="btr">
    <a href="javascript:void(0);" onclick="$(`#dguser`).datagrid(`reload`);" class="btn-sm bt-1 r20" title="Reload"><i class="fa-solid fa-sync fa-sm"></i></a>
</div>
<!-- TOP NAVIGASI END -->

<div class="m-4">
    <div class="m-1">
        <div class="mb-2">
            <div class="card" style="border-radius: 10px;border-left: 5px solid var(--pa);border-right: 5px solid var(--pa);">
                <div class="col">
                    <a href="" class="text-dark"><i class="fa fa-reply mr-2"></i><strong>Auto Reply</strong></a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-2">
                <div class="card table-responsive p-2" style="border-radius: 10px;border-left: 5px solid var(--pa);border-right: 5px solid var(--pa);">
                    <div class="col">
                        <small>
                            <strong>
                                CHAT APAPUN SELAIN COSTUME.
                            </strong>
                        </small>
                    </div>
                    <div class="card my-2">
                        <div class="row col">
                            <div class="col-md-6">
                                <input type="radio" name="i_reply_text" id="i_reply_text1" onclick="save1('updatestatus1','true')" class="mr-2" value="true">ENABLE
                            </div>
                            <div class="col-md-6">
                                <input type="radio" name="i_reply_text" id="i_reply_text2" onclick="save1('updatestatus1','false')" class="mr-2" value="false">DISABLE
                            </div>
                        </div>
                    </div>
                    <div class="card px-2 mb-2">
                        <strong>
                          Sertakan File :  {{#if REP.file}} 
                              <small><a href="javascript:void(0)" onclick="iframe('{{REP.file}}','{{REP.ext}}')"><i class="fa fa-file fa-2x m-1" title="Lihat file"></i></a></small>
                              <a href="javascript:void(0);" class="float-right" onclick="delincfile();"><i class="fa fa-trash text-danger ml-2" title="Hapus"></i></a>
                            {{/if}}
                            <a href="javascript:void(0);" onclick="infoExt();" class="badge bg-1 r20 ml-2 mt-1 float-right" title="Info"><i class="fa fa-info mx-1"></i></a>
               
                            <span class="image_upload float-right">
                                <label for="incfile">
                                    <a rel="nofollow" id="btn_img">
                                        <i class="fa fa-link" title="Upload"></i>
                                    </a>
                                </label>
                                <form id="fm2" method="post" enctype="multipart/form-data">
                                    <input type="file" accept="image/png,image/jpeg,image/gif,application/pdf" name="incfile" id="incfile">
                                </form>
                            </span>
                        </strong>
                    </div>
                    <strong>
                        Respon Text 
                        <a href="javascript:void(0);" id="bt_e_reply_text" class="float-right" onclick="edit_e(`reply_text`)"><i class="fa fa-edit text-success" title="Edit"></i></a>
                        <a href="javascript:void(0);" id="bt_s_reply_text" class="float-right" onclick="save1(`updateresp1`,$('#reply_text').val())"><i class="fa fa-save" title="Save"></i></a>
                      <script>$('#bt_s_reply_text').hide();</script>
                    </strong>
                    <textarea name="reply_text" id="reply_text" cols="30" rows="8" class="form-control">{{REP.resp}}</textarea>
                </div>
            </div>
            <div class="col-md-8 mb-2">
                <center>
                    <table id="dguser" toolbar="#toolbarCustomer" class="easyui-datagrid" singleSelect="true" style="width: 100%;height:356px" fitColumns="true" rowNumbers="true" pagination="true" url="/reply/getdata" pageSize="5" pageList="[5,10,25,50,75,100,125,150,200]">
                        <thead>
                            <tr>
                                <th field="id" width="100%" formatter="show_res" sortable="true">COSTUME</th>
                            </tr>
                        </thead>
                    </table>
                </center>
            </div>
        </div>
    </div>
 </div>   

<div id="toolbarCustomer">
    <div class="row p-1">
        <div class="col-md-6">
           <a href="javascript:void(0);" onclick="add();" class="btn-sm bg-1 r20 float-left" title="ADD"><i class="fa fa-plus"></i> </a>
           <a href="javascript:void(0);"
            onclick="$.messager.alert('INFO !',`
                 Klick kanang jika desktop sentuh tahan jika Mobile pada baris data Untuk menu lain.<br>
                <hr>
                 Dobel Klick baris data untuk Edit.
                 <hr>
                 Jika baris data merah artinya respon DISABLE.
                `);" 
           class="btn-sm bg-1 r20 float-left ml-2" title="Info"><i class="fa fa-info mx-1"></i></a>
        </div>
        <div class="col-md-6">
            <input id="searchCustomer" class="easyui-searchbox" data-options="prompt:'Cari..',searcher:doSearchCustomer,
            inputEvents: $.extend({}, $.fn.searchbox.defaults.inputEvents, {
                keyup: function(e){
                    var t = $(e.data.target);
                    var opts = t.searchbox('options');
                    t.searchbox('setValue', $(this).val());
                    opts.searcher.call(t[0],t.searchbox('getValue'),t.searchbox('getName'));
                }
            })
        " style="width:100%;"></input>
            <script>
                function doSearchCustomer() {
                    $('#dguser').datagrid('load', {
                        search: $('#searchCustomer').val()
                    });
                }
            </script>
            <!---------SEARCH BOX END----------->
        </div>
    </div>
</div>
<!-- KLICK KANAN START -->
<div id="mm" class="easyui-menu">
    <a href="javascript:void(0)" class="btn-sm form-control mb-1" plain="true" onClick="edit();"><i class="fa fa-edit mr-2"></i>Edit</a>
    <a href="javascript:void(0)" class="btn-sm form-control mb-1" plain="true" onClick="change_status();"><span id="btn-status"></span></a>
    <span id="bthps"></span>
    <a href="javascript:void(0)" class="btn-sm form-control" plain="true" onClick="destroyuser();"><i class="fa fa-trash mr-2 text-danger"></i> Hapus</a>
</div>
<!-- KLICK KANAN END -->
<!-- Start Modal 1 -->
<div class="modal fade" id="edit" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div id="head"></div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <form id="fm" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="id" id="id">
                    <input type="hidden" name="ext" id="ext">
                    <input type="hidden" name="file" id="file">
                    <small><strong>Chat</strong></small>
                    <input type="text" name="text" id="text" class="form-control">
                    <small><strong>Respon Text</strong></small>
                    <textarea name="resp" id="resp" cols="30" rows="5" class="form-control"></textarea>
                    <br>
                    <input type="file" name="fileIn" id="fileIn" onchange="fileOn()">
                    <a href="javascript:void(0);" onclick="infoExt();" class="badge bg-1 r20 ml-2" title="Info"><i class="fa fa-info mx-1 fa-sm"></i></a>
                </form>

            </div>
            <div class="modal-footer">
                <a href="javascript:void(0);" onclick="saver();" class="btn btn-outline-dark btn-sm"><i class="fa fa-save mr-2"></i>Save</a>
            </div>

        </div>
    </div>
</div>
<!-- End Modal 1-->
<!-- Start Modal 1 -->
<div class="modal fade" id="show" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <button type="button" class="close float-right text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        <center>
            <div id="iframe"></div>
        </center>
    </div>
</div>
<!-- End Modal 1-->
<script>
$('#reply_text').attr('readonly','true');
var st1 = "{{ REP.status }}";
if (st1 == 'true') {
    document.getElementById('i_reply_text2').checked = false;
    document.getElementById('i_reply_text1').checked = true;
} else {
    document.getElementById('i_reply_text1').checked = false;
    document.getElementById('i_reply_text2').checked = true;
}
//-----------------------------------------start
function add() {
    $('#fm').form('clear');
    document.getElementById("ext").value = '';
    document.getElementById("file").value = '';
    document.getElementById("fileIn").value = '';
    document.getElementById("head").innerHTML = '<h5 class="modal-title"><i class="fa fa-plus mr-2"></i>Tambah Data</h5>';
    document.getElementById("id").value = 'insert';
    $('#edit').modal('show');
}
//-----------------------------------------end
//-----------------------------------------start
function edit() {
    var row = $('#dguser').datagrid('getSelected');
    if (row) {
        $('#fm').form('load', row);
        document.getElementById("fileIn").value = '';
        document.getElementById("head").innerHTML = '<h5 class="modal-title"><i class="fa fa-edit mr-2"></i>Edit Data</h5>';
        $('#edit').modal('show');
    }
}
//-----------------------------------------end
//===========================================
function saver() {
    var id = $('#id').val();
    var ext = ($('#ext').val())?$('#ext').val():null;
    var file = ($('#file').val())?$('#file').val():null;
    var text = document.getElementById("text").value;
    if (text == '') {
        msg('Error','chat Belum Di isi.');
        $('#text').focus();
        return;
    }
    var resp = document.getElementById("resp").value;
    if (resp == '') {
        msg('Error','respon text harus Di isi.');
        $('#resp').focus();
        return;
    }
    $.post("/reply/crud", {id,text,resp,ext,file} ,function(r) {
        if (r.success) {
                $('#edit').modal('hide');
                $('#dguser').datagrid('reload');
                msg('Success !', 'Berhasil di Save');
        } else {
            msg('Error', r.errorMsg);
        }
    }, 'json');
}
//===========================================
//===========================================
function iframe(src,ext) {
    if(ext=='pdf'){
        $('#iframe').html(`<iframe src="data:application/`+ext+`;base64,`+src+`" id="iframe" frameborder="0" width="100%" height="1000px"></iframe>`);
    }else{
        $('#iframe').html(`<img src="data:image/`+ext+`;base64,`+src+`" width="80%">`);
    }
    $('#show').modal('show');
}
//===========================================
//===========================================
function infoExt(){
    $.messager.alert('INFO !',`
        Extensi di izinkan :<br>
        png , jpg , jpeg , pdf
    `);
}
//===========================================
//===========================================
function edit_e(id) {
    $('#bt_e_'+id).hide();
    $('#bt_s_'+id).show();
    $('#'+id).attr('readonly',false);
}
//===========================================
//===========================================
function close_e(id) {
    $('#bt_e_'+id).show();
    $('#bt_s_'+id).hide();
    $('#'+id).attr('readonly',true);
}
//===========================================
//===========================================
//-----------------------------------------start
function show_res(val, row) {
    for (var name in row) {
        status = (row.status == 'true') ? '' : 'bg-danger text-white';
        ext = (row.ext == 'pdf') ? 'pdf' : 'image';
        file = (row.file==null || row.file=='')?'':`<div class="col-md-1">
                                    <a href="javascript:void(0);" class="btn-sm bt-1 r20" onclick="iframe('`+row.file+`','`+row.ext+`')">
                                      <i class="fa fa-file-`+ext+`" title="File"></i>
                                    </a> 
                                  </div>`;
        return t = `<div class="card col table-responsive my-1 py-1 `+status+`"style="border-radius: 10px;border-left: 5px solid dev(--pa);border-right: 5px solid dev(--pa);">
                        <div class="row">
                            <div class="col-md-1">
                                <small>Chat</small> :
                            </div>
                            <div class="col-md-10">
                                <strong> ` + row.text + `</strong>  
                            </div>
                            ` + file + `
                        </div>
                    </div>`;
                    // <i class="fa fa-file"><i>
    }
}
//-----------------------------------------end
//-----------------------------------------start
function destroyuser() {
    var row = $('#dguser').datagrid('getSelected');
    if (row) {
        $.messager.confirm('Attention!', '<strong class="text-danger">Hati-hati Melakukan aksi ini,</strong><br> Apakah Anda Yakin Ingin Menghapus data ini ?<br>Chat : ' + row.text, function(r) {
            if (r) {
                $.post("/reply/delete", {
                    id: row.id
                }, function(result) {
                    if (result.success) {
                        $('#dguser').datagrid('reload');
                        msg('Success !', 'Berhasil Di Hapus');
                    } else {
                        msg('Error', result.errorMsg);
                    }
                }, 'json');
            }
        });
    }
}
//-----------------------------------------end
//-----------------------------------------start
function change_status() {
    var row = $('#dguser').datagrid('getSelected');
    if (row) {
        $.messager.confirm('Attention!', '<strong class="text-danger">Hati-hati Melakukan aksi ini,</strong><br> Apakah Anda Yakin Ingin Merubah Status data ini ?<br>Chat : ' + row.text, function(r) {
            if (r) {
                var status = (row.status=="true")?"false":"true";
                $.post("/reply/status", {
                     id: row.id,status
                }, function(result) {
                    if (result.success) {
                        $('#dguser').datagrid('reload');
                        msg('Success !', 'Status Berhasil Di Ubah');
                    } else {
                        msg('Error', result.errorMsg);
                    }
                }, 'json');
            }
        });
    }
}
//-----------------------------------------end
//-----------------------------------------start
function hpsfile() {
    var row = $('#dguser').datagrid('getSelected');
    if (row) {
        $.messager.confirm('Attention!', '<strong class="text-danger">Hati-hati Melakukan aksi ini,</strong><br> Apakah Anda Yakin Ingin Menghapus file di data ini ?<br>Chat : ' + row.text, function(r) {
            if (r) {
                $.post("/reply/deletefile", {
                    id: row.id
                }, function(result) {
                    if (result.success) {
                        $('#dguser').datagrid('reload');
                        msg('Success !', 'File berhasil Di Hapus');
                    } else {
                        msg('Error', result.errorMsg);
                    }
                }, 'json');
            }
        });
    }
}
//-----------------------------------------end
//-----------------------------------------start
function delincfile() {
    $.messager.confirm('Attention!', '<strong class="text-danger">Hati-hati Melakukan aksi ini,</strong><br> Apakah Anda Yakin Ingin Menghapus file di data ini ?', function(r) {
        if (r) {
            $.post("/reply/delfile1", function(result) {
                if (result.success) {
                    msg('Success !', 'File berhasil Di Hapus');
                    window.location.reload();
                } else {
                    msg('Error', result.errorMsg);
                }
            }, 'json');
        }
    });
}
//-----------------------------------------end
//===========================================
function fileOn(){
  var file = document.getElementById("fileIn").files[0];
  var reader = new FileReader();
  reader.onloadend = function() {
    var re = reader.result;
    var ext = re.split(";");
        ext = ext[0].split("/");
        ext = ext[1];
    var base64 = re.split(",");
        base64 = base64[1];
    $("#ext").val(ext);
    $("#file").val(base64);
  }
  reader.readAsDataURL(file);
}
//===========================================
//===========================================
$('#incfile').on('change', function() {
  var file = document.getElementById("incfile").files[0];
  var reader = new FileReader();
  reader.onloadend = function() {
    var re = reader.result;
    var ext = re.split(";");
        ext = ext[0].split("/");
        ext = ext[1];
    var base64 = re.split(",");
        base64 = base64[1];
    $.post("/reply/updatefile1", {ext,base64} ,function(r) {
        if (r.success) {
            msg('Success !', 'Berhasil di upload');
            window.location.reload();
        } else {
            msg('Error', r.errorMsg);
        }
    }, 'json');
  }
  reader.readAsDataURL(file);
});
//===========================================
function save1(url,val){
    $.post("/reply/"+url, {val} ,function(r) {
        if (r.success) {
            msg('Success !', 'Berhasil di Save');
            if(url=="updateresp1"){
                close_e("reply_text")
            }
        } else {
            msg('Error', r.errorMsg);
        }
    }, 'json');
}
//-----------------------------------------start
$(function() {
    $('#dguser').datagrid({
        singleSelect: true,
        onRowContextMenu: function(e, index, row) {
            if (row.file == '' || row.file==null){
                $('#bthps').html('')
            }else{
                $('#bthps').html(`<a href="javascript:void(0)" class="btn-sm form-control mb-1" plain="true" onClick="hpsfile();"><i class="fa fa-times mr-2 text-danger"></i> Hapus File</a>`);
            }
            if (row.status == 'true') {
                document.getElementById("btn-status").innerHTML = '<i class="fa fa-power-off text-danger mr-2"></i>DISABLE';
            } else {
                document.getElementById("btn-status").innerHTML = '<i class="fa fa-check text-success mr-2"></i>ENABLE';
            }
            $(this).datagrid('selectRow', index);
            e.preventDefault();
            $('#mm').menu('show', {
                left: e.pageX,
                top: e.pageY
            });
        },
        onDblClickRow: function() {
            edit();
        }
    })

})
//-----------------------------------------end
</script>